namespace particles {
    export class Shape2Factory extends AreaFactory {
        protected sources: Image[];
        protected ox: Fx8;
        protected oy: Fx8;

        constructor(xRange: number, yRange: number, source: Image) {
            super(xRange, yRange);
            this.sources = [source];

            // Base offsets off of initial shape
            this.ox = Fx8(source.width >> 1);
            this.oy = Fx8(source.height >> 1);
        }

        /**
         * Add another possible shape for a particle to display as
         * @param shape 
         */
        addShape(shape: Image) {
            if (shape) this.sources.push(shape);
        }

        drawParticle(p: Particle, x: Fx8, y: Fx8) {
            const pImage = this.galois.pickRandom(this.sources).clone();


            screen.drawTransparentImage(pImage,
                Fx.toInt(Fx.sub(x, this.ox)),
                Fx.toInt(Fx.sub(y, this.oy))
            );
        }

        createParticle(anchor: ParticleAnchor) {
            const p = super.createParticle(anchor);
            p.color = this.galois.randomRange(1, 14);
            return p;
        }
    }

    
    export class RainFactory extends ShapeFactory {
        constructor(xRange: number) {
            const rain = [
                img`
                    . 6 .
                    6 9 6
                    6 9 6
                    6 9 6
                    6 9 6
                    6 9 6
                    6 9 6
                    6 9 6
                    . 6 .
                `];
            super(xRange, 0, rain[0])
        }
    }

    export class StormFactory extends ParticleFactory {
        minRate: number;
        maxRate: number;
        clouds: Image[];
        camera: scene.Camera;

        constructor(minRate: number = 8, maxRate: number = 12) {
            super();

            this.minRate = minRate;
            this.maxRate = maxRate;
            this.camera = game.currentScene().camera;

            this.clouds = [
                img`
                    bbbbbbbbbbbbbbbbbbbbbb
                    bbbbbbbbbbbbbbbbbbbbbb
                    bbbbbbbbbbbbbbccccbbbb
                    bbbbcccccbbbbbbbbccbbb
                    bbbbcbbbbbbbbbbbbbccbb
                    bbbbcbbbbbcbbbbbbbbcbb
                    bbbbbbbbbccbbbbbbbbbbb
                    bbbbbbbbbcbbbbbbbbbbbb
                    bbbbbbbbbcbbbbbbbbbbbb
                    bbbbbbbbbbbbbbbbbbbbbb
                    bbbbbbbbbbbbbbccccbbbb
                    bbbbbbbbbbbbbbbbbccbbb
                    fbbbcbbbbbbfbbbbbbcbbb
                    .fbbcbbbbbf.fbbbbbcbbf
                    ..ffcbbbff...ffbbbbff.
                    ....ffff.......ffff...
                    ......................
                    ......................
                    ......................
                    ......................
                `];
        }

        createParticle(anchor: ParticleAnchor) {
            const p = super.createParticle(anchor);
            const yRange = anchor.height ? anchor.height >> 1 : 8;
            p.data = Math.randomRange(0, this.clouds.length - 1);
            p._x = Fx8(anchor.width ? anchor.x + (anchor.width >> 1) : anchor.x)
            p._y = Fx.add(
                Fx8(-11),
                Fx8(this.clouds[p.data].width >> 1)
            );
            p.vx = Fx8(-25);

            // p.color stores information on conjoined clouds
            p.color = 0;
            if (Math.percentChance(30)) {
                const isConjoined = 1 << 0;
                const isOffsetX = Math.randomRange(0, 1) << 1;
                const isOffsetY = Math.randomRange(0, 1) << 2;
                const selection = Math.randomRange(0, this.clouds.length - 1) << 3;

                p.color = isConjoined | isOffsetX | isOffsetY | selection;
            }

            p.lifespan = Fx.toInt(
                Fx.mul(
                    Fx.div(
                        Fx8(screen.width + 30),
                        Fx.abs(p.vx)
                    ),
                    Fx8(1000)
                )
            );

            return p;
        }

        drawParticle(p: particles.Particle, x: Fx8, y: Fx8) {
            const mainImage = this.clouds[p.data];
            screen.drawTransparentImage(
                mainImage,
                Fx.toInt(x),
                Fx.toInt(y)
            );

            if (p.color & 1) {
                const isOffsetX = (p.color >> 1) & 1;
                const isOffsetY = (p.color >> 2) & 1;
                const selection = this.clouds[p.color >> 3];

                const xOffset = isOffsetX ? Fx8(mainImage.width >> 2) : Fx.zeroFx8;
                const yOffset = isOffsetY ? Fx8(mainImage.height >> 2) : Fx.zeroFx8;

                screen.drawTransparentImage(
                    selection,
                    Fx.toInt(Fx.add(x, xOffset)),
                    Fx.toInt(Fx.add(y, yOffset))
                );
            }
        }
    }
    export class LightningFactory extends Shape2Factory {
        constructor(xRange: number, yRange: number) {
            const lightning = [
                img`
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111155
                    .......................455111111111111111111111155
                    .......................455111111111111111111111554
                    .......................455111111111111111111111554
                    .......................45511111111111111111111554.
                    ......................455111111111111111111111554.
                    ......................45511111111111111111111554..
                    ......................45511111111111111111111554..
                    .....................45511111111111111111111554...
                    .....................45511111111111111111111554...
                    .....................4551111111111111111111554....
                    ....................45511111111111111111111554....
                    ....................4551111111111111111111554.....
                    ....................4551111111111111111111554.....
                    ...................4551111111111111111111554......
                    ...................4551111111111111111111554......
                    ...................455111111111111111111554.......
                    ...................455111111111111111111554.......
                    ..................455111111111111111111554........
                    ..................455111111111111111111554........
                    ..................45511111111111111111554.........
                    .................455111111111111111111554.........
                    .................45511111111111111111554..........
                    .................45511111111111111111554..........
                    ................45511111111111111111554...........
                    ................45511111111111111111554...........
                    ................4551111111111111111554............
                    ...............45511111111111111111554............
                    ...............4551111111111111111554.............
                    ...............4551111111111111111554.............
                    ...............455111111111111111554..............
                    ..............4551111111111111111554..............
                    ..............455111111111111111554...............
                    ..............455111111111111111554...............
                    .............455111111111111111554................
                    .............455111111111111111554................
                    .............45511111111111111554.................
                    ............455111111111111111554.................
                    ............45511111111111111554..................
                    .............4551111111111111554..................
                    .............455111111111111554...................
                    ..............45511111111111554...................
                    ...............45511111111111554..................
                    ................4551111111111554..................
                    ................45511111111111554.................
                    .................4551111111111554.................
                    ..................4551111111111554................
                    ..................4551111111111554................
                    ...................4551111111111554...............
                    ....................455111111111554...............
                    .....................455111111111554..............
                    .....................455111111111554..............
                    ......................455111111111554.............
                    .......................45511111111554.............
                    .......................4551111111554..............
                    .......................4551111111554..............
                    .......................455111111554...............
                    ......................4551111111554...............
                    ......................455111111554................
                    ......................455111111554................
                    ......................45511111554.................
                    .....................455111111554.................
                    .....................45511111554..................
                    .....................45511111554..................
                    ....................45511111554...................
                    ....................45511111554...................
                    ....................4551111554....................
                    ....................4551111554....................
                    ...................4551111554.....................
                    ...................4551111554.....................
                    ...................455111554......................
                    ..................4551111554......................
                    ..................455111554.......................
                    ..................455111554.......................
                    .................455111554........................
                    .................455111554........................
                    .................45511554.........................
                    .................45511554.........................
                    ................45511554..........................
                    ................45511554..........................
                    ................4551554...........................
                    ...............45511554...........................
                    ...............4551554............................
                    ...............4551554............................
                    ..............4551554.............................
                    ..............4551554.............................
                    ..............455554..............................
                    ..............45554...............................
                    ...............454................................
                    ................4.................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                `,
                img`
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111155
                    .......................455111111111111111111111155
                    .......................455111111111111111111111554
                    .......................455111111111111111111111554
                    .......................45511111111111111111111554.
                    ......................455111111111111111111111554.
                    ......................45511111111111111111111554..
                    ......................45511111111111111111111554..
                    .....................45511111111111111111111554...
                    .....................45511111111111111111111554...
                    .....................4551111111111111111111554....
                    ....................45511111111111111111111554....
                    ....................4551111111111111111111554.....
                    ....................4551111111111111111111554.....
                    ...................4551111111111111111111554......
                    ...................4551111111111111111111554......
                    ...................455111111111111111111554.......
                    ...................455111111111111111111554.......
                    ..................455111111111111111111554........
                    ..................455111111111111111111554........
                    ..................45511111111111111111554.........
                    .................455111111111111111111554.........
                    .................45511111111111111111554..........
                    .................45511111111111111111554..........
                    ................45511111111111111111554...........
                    ................45511111111111111111554...........
                    ................4551111111111111111554............
                    ...............45511111111111111111554............
                    ...............4551111111111111111554.............
                    ...............4551111111111111111554.............
                    ...............455111111111111111554..............
                    ..............4551111111111111111554..............
                    ..............455111111111111111554...............
                    ..............455111111111111111554...............
                    .............455111111111111111554................
                    .............455111111111111111554................
                    .............45511111111111111554.................
                    ............455111111111111111554.................
                    ............45511111111111111554..................
                    .............4551111111111111554..................
                    .............455111111111111554...................
                    ..............45511111111111554...................
                    ...............45511111111111554..................
                    ................4551111111111554..................
                    ................45511111111111554.................
                    .................4551111111111554.................
                    ..................4551111111111554................
                    ..................4551111111111554................
                    ...................4551111111111554...............
                    ....................455111111111554...............
                    .....................455111111111554..............
                    .....................455111111111554..............
                    ......................455111111111554.............
                    .......................45511111111554.............
                    .......................4551111111554..............
                    .......................4551111111554..............
                    .......................455111111554...............
                    ......................4551111111554...............
                    ......................455111111554................
                    ......................455111111554................
                    ......................45511111554.................
                    .....................455111111554.................
                    .....................45511111554..................
                    .....................45511111554..................
                    ....................45511111554...................
                    ....................45511111554...................
                    ....................4551111554....................
                    ....................4551111554....................
                    ...................4551111554.....................
                    ...................4551111554.....................
                    ...................455111554......................
                    ..................4551111554......................
                    ..................455111554.......................
                    ..................455111554.......................
                    .................455111554........................
                    .................455111554........................
                    .................45511554.........................
                    .................45511554.........................
                    ................45511554..........................
                    ................45511554..........................
                    ................4551554...........................
                    ...............45511554...........................
                    ...............4551554............................
                    ...............4551554............................
                    ..............4551554.............................
                    ..............4551554.............................
                    ..............455554..............................
                    ..............45554...............................
                    ...............454................................
                    ................4.................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                `,
                img`
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111155
                    .......................455111111111111111111111155
                    .......................455111111111111111111111554
                    .......................455111111111111111111111554
                    .......................45511111111111111111111554.
                    ......................455111111111111111111111554.
                    ......................45511111111111111111111554..
                    ......................45511111111111111111111554..
                    .....................45511111111111111111111554...
                    .....................45511111111111111111111554...
                    .....................4551111111111111111111554....
                    ....................45511111111111111111111554....
                    ....................4551111111111111111111554.....
                    ....................4551111111111111111111554.....
                    ...................4551111111111111111111554......
                    ...................4551111111111111111111554......
                    ...................455111111111111111111554.......
                    ...................455111111111111111111554.......
                    ..................455111111111111111111554........
                    ..................455111111111111111111554........
                    ..................45511111111111111111554.........
                    .................455111111111111111111554.........
                    .................45511111111111111111554..........
                    .................45511111111111111111554..........
                    ................45511111111111111111554...........
                    ................45511111111111111111554...........
                    ................4551111111111111111554............
                    ...............45511111111111111111554............
                    ...............4551111111111111111554.............
                    ...............4551111111111111111554.............
                    ...............455111111111111111554..............
                    ..............4551111111111111111554..............
                    ..............455111111111111111554...............
                    ..............455111111111111111554...............
                    .............455111111111111111554................
                    .............455111111111111111554................
                    .............45511111111111111554.................
                    ............455111111111111111554.................
                    ............45511111111111111554..................
                    .............4551111111111111554..................
                    .............455111111111111554...................
                    ..............45511111111111554...................
                    ...............45511111111111554..................
                    ................4551111111111554..................
                    ................45511111111111554.................
                    .................4551111111111554.................
                    ..................4551111111111554................
                    ..................4551111111111554................
                    ...................4551111111111554...............
                    ....................455111111111554...............
                    .....................455111111111554..............
                    .....................455111111111554..............
                    ......................455111111111554.............
                    .......................45511111111554.............
                    .......................4551111111554..............
                    .......................4551111111554..............
                    .......................455111111554...............
                    ......................4551111111554...............
                    ......................455111111554................
                    ......................455111111554................
                    ......................45511111554.................
                    .....................455111111554.................
                    .....................45511111554..................
                    .....................45511111554..................
                    ....................45511111554...................
                    ....................45511111554...................
                    ....................4551111554....................
                    ....................4551111554....................
                    ...................4551111554.....................
                    ...................4551111554.....................
                    ...................455111554......................
                    ..................4551111554......................
                    ..................455111554.......................
                    ..................455111554.......................
                    .................455111554........................
                    .................455111554........................
                    .................45511554.........................
                    .................45511554.........................
                    ................45511554..........................
                    ................45511554..........................
                    ................4551554...........................
                    ...............45511554...........................
                    ...............4551554............................
                    ...............4551554............................
                    ..............4551554.............................
                    ..............4551554.............................
                    ..............455554..............................
                    ..............45554...............................
                    ...............454................................
                    ................4.................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                `,
                img`
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111115
                    ........................45511111111111111111111155
                    .......................455111111111111111111111155
                    .......................455111111111111111111111554
                    .......................455111111111111111111111554
                    .......................45511111111111111111111554.
                    ......................455111111111111111111111554.
                    ......................45511111111111111111111554..
                    ......................45511111111111111111111554..
                    .....................45511111111111111111111554...
                    .....................45511111111111111111111554...
                    .....................4551111111111111111111554....
                    ....................45511111111111111111111554....
                    ....................4551111111111111111111554.....
                    ....................4551111111111111111111554.....
                    ...................4551111111111111111111554......
                    ...................4551111111111111111111554......
                    ...................455111111111111111111554.......
                    ...................455111111111111111111554.......
                    ..................455111111111111111111554........
                    ..................455111111111111111111554........
                    ..................45511111111111111111554.........
                    .................455111111111111111111554.........
                    .................45511111111111111111554..........
                    .................45511111111111111111554..........
                    ................45511111111111111111554...........
                    ................45511111111111111111554...........
                    ................4551111111111111111554............
                    ...............45511111111111111111554............
                    ...............4551111111111111111554.............
                    ...............4551111111111111111554.............
                    ...............455111111111111111554..............
                    ..............4551111111111111111554..............
                    ..............455111111111111111554...............
                    ..............455111111111111111554...............
                    .............455111111111111111554................
                    .............455111111111111111554................
                    .............45511111111111111554.................
                    ............455111111111111111554.................
                    ............45511111111111111554..................
                    .............4551111111111111554..................
                    .............455111111111111554...................
                    ..............45511111111111554...................
                    ...............45511111111111554..................
                    ................4551111111111554..................
                    ................45511111111111554.................
                    .................4551111111111554.................
                    ..................4551111111111554................
                    ..................4551111111111554................
                    ...................4551111111111554...............
                    ....................455111111111554...............
                    .....................455111111111554..............
                    .....................455111111111554..............
                    ......................455111111111554.............
                    .......................45511111111554.............
                    .......................4551111111554..............
                    .......................4551111111554..............
                    .......................455111111554...............
                    ......................4551111111554...............
                    ......................455111111554................
                    ......................455111111554................
                    ......................45511111554.................
                    .....................455111111554.................
                    .....................45511111554..................
                    .....................45511111554..................
                    ....................45511111554...................
                    ....................45511111554...................
                    ....................4551111554....................
                    ....................4551111554....................
                    ...................4551111554.....................
                    ...................4551111554.....................
                    ...................455111554......................
                    ..................4551111554......................
                    ..................455111554.......................
                    ..................455111554.......................
                    .................455111554........................
                    .................455111554........................
                    .................45511554.........................
                    .................45511554.........................
                    ................45511554..........................
                    ................45511554..........................
                    ................4551554...........................
                    ...............45511554...........................
                    ...............4551554............................
                    ...............4551554............................
                    ..............4551554.............................
                    ..............4551554.............................
                    ..............455554..............................
                    ..............45554...............................
                    ...............454................................
                    ................4.................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                `,
                img`
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                    ..................................................
                `];
            super(xRange, yRange, lightning[0]);
            }
        }
    export class AshParticleFactory extends ShapeFactory {
        constructor(xRange: number) {
            const ash = [
                img`
                    . 1 .
                    1 1 1
                    . 1 .
                `,
                img`
                    . d .
                    d d d
                    . d .
                `,
                img`
                    . b .
                    b b b
                    . b .
                `];
            super(xRange, 0, ash[0])
        }
    }
}